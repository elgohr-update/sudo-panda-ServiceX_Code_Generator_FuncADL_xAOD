[![GitHub Actions Status](https://github.com/ssl-hep/ServiceX_Code_Generator_FuncADL_xAOD/workflows/CI/CD/badge.svg)](https://github.com/ssl-hep/ServiceX_Code_Generator_FuncADL_xAOD/actions)
[![Code Coverage](https://codecov.io/gh/ssl-hep/ServiceX_Code_Generator_FuncADL_xAOD/graph/badge.svg)](https://codecov.io/gh/ssl-hep/ServiceX_Code_Generator_FuncADL_xAOD)


ServiceX Code Generator
-----------------------
This microservice is a REST API that will generate C++ source code that runs in the ATLAS environment to generate code that will extract columns of data from ATLAS xAOD binary files. The query to extract the data is generated by the func-adl LINQ-like language, and specified to the service using the ast-language.

Usage
-----
This repo builds a container to be used in the `ServiceX` application. You can see the containers on docker hub.

### Running the web service

The default is to run a web service that will take a `qastle` as input and return a binary zip file as output. To start that up, use the following docker command:

```
 docker run -it --rm -p 5000:5000  servicexcodegeneratorfuncadlxaod:latest
```

You can now make queries against port 5000.

### Translating a `qastle` into code

For debugging purposes you sometimes want to translate an `ast` into a zip file. This container will also do that for you:

```
echo "(call ResultTTree (call Select (call SelectMany (call EventDataset (list 'localds://did_01')) (lambda (list e) (call (attr e 'Jets') ''))) (lambda (list j) (call (attr j 'pt')))) (list 'jet_pt') 'analysis' 'junk.root')" |  docker run -i --rm -v ${PWD}:/zip  servicexcodegeneratorfuncadlxaod:latest translate -z /zip/junk.zip
```

After running, that will leave a `zip` file in your home directory that contains the 6 or so files necessary to run the requested transform. The only thing missing are the input files.

Development
-----------

- Use `pytest` to run the tests
- Build a `docker` image using the command `docker build --rm -f "Dockerfile" -t servicexcodegeneratorfuncadlxaod:latest "."` to build the image, and the docker command `docker run -it --rm -p 5000:5000  servicexcodegeneratorfuncadlxaod:latest` to run it in interactive mode so you can see the log files.
- Use the `postman` template to send some sample queries to the service.

Debugging & Tools
-----------------

Sometimes it is useful to generate C++ from the `ast-language` text. There is a utility in `scripts/from_ast_to_zip.py` that will do this for you. For example:
```
echo "(call ResultTTree (call Select (call SelectMany (call EventDataset (list 'localds://did_01')) (lambda (list e) (call (attr e 'Jets') ''))) (lambda (list j) (call (attr j 'pt')))) (list 'jet_pt') 'analysis' 'junk.root')" | python ./scripts/from_ast_to_zip.py -z junk.zip
```

This will generate a zip file that contains the C++ source code.
